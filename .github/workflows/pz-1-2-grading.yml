name: PZ 1/2 - Automated Grading

on:
  pull_request:
    branches:
      - master
    paths:
      - 'src/**'
      - 'pom.xml'

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: -Xmx1024m

jobs:
  # ============================================================================
  # JOB 1: Detect Variant (A/B/C)
  # ============================================================================
  detect-variant:
    name: üîç Detect Student Variant
    runs-on: ubuntu-latest
    outputs:
      variant: ${{ steps.detect.outputs.variant }}
      variant_name: ${{ steps.detect.outputs.variant_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect variant from code
        id: detect
        run: |
          # Detect variant based on Entity class names (more precise patterns)
          if grep -r "class SupplyCategory" src/main/java/ && grep -r "class SupplyItem" src/main/java/ && grep -r "class Warehouse" src/main/java/; then
            echo "variant=A" >> $GITHUB_OUTPUT
            echo "variant_name=Supply Management (–ú–¢–ó)" >> $GITHUB_OUTPUT
            echo "category_entity=SupplyCategory" >> $GITHUB_OUTPUT
            echo "item_entity=SupplyItem" >> $GITHUB_OUTPUT
            echo "location_entity=Warehouse" >> $GITHUB_OUTPUT
          elif grep -r "class VehicleCategory" src/main/java/ && grep -r "class Vehicle[^A-Za-z]" src/main/java/ && grep -r "class Driver" src/main/java/; then
            echo "variant=B" >> $GITHUB_OUTPUT
            echo "variant_name=Vehicle Management (–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç)" >> $GITHUB_OUTPUT
            echo "category_entity=VehicleCategory" >> $GITHUB_OUTPUT
            echo "item_entity=Vehicle" >> $GITHUB_OUTPUT
            echo "location_entity=Driver" >> $GITHUB_OUTPUT
          elif grep -r "class UnitType" src/main/java/ && grep -r "class MilitaryUnit" src/main/java/ && grep -r "class Personnel" src/main/java/; then
            echo "variant=C" >> $GITHUB_OUTPUT
            echo "variant_name=Personnel Management (–ü–µ—Ä—Å–æ–Ω–∞–ª)" >> $GITHUB_OUTPUT
            echo "category_entity=UnitType" >> $GITHUB_OUTPUT
            echo "item_entity=Personnel" >> $GITHUB_OUTPUT
            echo "location_entity=MilitaryUnit" >> $GITHUB_OUTPUT
          else
            echo "variant=UNKNOWN" >> $GITHUB_OUTPUT
            echo "variant_name=Unknown - No valid entities detected" >> $GITHUB_OUTPUT
          fi

      - name: Display detected variant
        run: |
          echo "### üéØ Detected Variant: ${{ steps.detect.outputs.variant }}" >> $GITHUB_STEP_SUMMARY
          echo "**Variant Name:** ${{ steps.detect.outputs.variant_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.detect.outputs.variant }}" != "UNKNOWN" ]; then
            echo "**Expected Entities:**" >> $GITHUB_STEP_SUMMARY
            echo "- Category: ${{ steps.detect.outputs.category_entity }}" >> $GITHUB_STEP_SUMMARY
            echo "- Item: ${{ steps.detect.outputs.item_entity }}" >> $GITHUB_STEP_SUMMARY
            echo "- Location/Person: ${{ steps.detect.outputs.location_entity }}" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # JOB 2: Build & Compile (–û–ë–û–í'–Ø–ó–ö–û–í–û - 0 –±–∞–ª—ñ–≤ —è–∫—â–æ –Ω–µ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è)
  # ============================================================================
  build:
    name: üèóÔ∏è Build & Compile
    runs-on: ubuntu-latest
    needs: detect-variant
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        id: build
        run: |
          echo "### üèóÔ∏è Build Results" >> $GITHUB_STEP_SUMMARY
          if mvn clean compile -B; then
            echo "build_status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ **Build:** SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "build_status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå **Build:** FAILED - 0 –±–∞–ª—ñ–≤ (–ø—Ä–æ—î–∫—Ç –Ω–µ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Package application
        run: mvn package -DskipTests -B

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 7

  # ============================================================================
  # JOB 3: Code Style Check (Checkstyle)
  # ============================================================================
  checkstyle:
    name: üìã Code Style Check
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Run Checkstyle
        id: checkstyle
        continue-on-error: true
        run: |
          mvn checkstyle:check -B > checkstyle-output.txt 2>&1 || true
          
          # Extract violations count
          VIOLATIONS=$(grep -oP '\[ERROR\]' checkstyle-output.txt | wc -l || echo "0")
          echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
          
          echo "### üìã Checkstyle Results" >> $GITHUB_STEP_SUMMARY
          echo "**Violations:** $VIOLATIONS" >> $GITHUB_STEP_SUMMARY
          
          if [ "$VIOLATIONS" -eq 0 ]; then
            echo "‚úÖ **Status:** PASSED - No violations" >> $GITHUB_STEP_SUMMARY
          elif [ "$VIOLATIONS" -le 10 ]; then
            echo "‚ö†Ô∏è **Status:** MINOR ISSUES - $VIOLATIONS violations (–º—ñ–Ω—ñ–º–∞–ª—å–Ω–µ –∑–Ω–∏–∂–µ–Ω–Ω—è)" >> $GITHUB_STEP_SUMMARY
          elif [ "$VIOLATIONS" -le 30 ]; then
            echo "‚ö†Ô∏è **Status:** MODERATE ISSUES - $VIOLATIONS violations (–ø–æ–º—ñ—Ä–Ω–µ –∑–Ω–∏–∂–µ–Ω–Ω—è)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** MAJOR ISSUES - $VIOLATIONS violations (–∑–Ω–∞—á–Ω–µ –∑–Ω–∏–∂–µ–Ω–Ω—è)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show first 20 violations
          echo "<details><summary>Checkstyle Violations</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep '\[ERROR\]' checkstyle-output.txt | head -20 >> $GITHUB_STEP_SUMMARY || echo "No violations" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload Checkstyle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: checkstyle-output.txt

  # ============================================================================
  # JOB 4: Project Structure Validation
  # ============================================================================
  structure-check:
    name: üèõÔ∏è Project Structure Check
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate package structure
        id: structure
        run: |
          echo "### üèõÔ∏è Project Structure Validation" >> $GITHUB_STEP_SUMMARY
          
          BASE_PATH="src/main/java/ua/edu/viti/military"
          SCORE=0
          MAX_SCORE=7
          
          # Check required packages
          PACKAGES=("entity" "repository" "service" "controller" "dto" "exception" "config")
          
          echo "**Required Packages:**" >> $GITHUB_STEP_SUMMARY
          for pkg in "${PACKAGES[@]}"; do
            if [ -d "$BASE_PATH/$pkg" ]; then
              echo "‚úÖ $pkg/" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 1))
            else
              echo "‚ùå $pkg/ - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          # Check DTO subpackages
          if [ -d "$BASE_PATH/dto/request" ] && [ -d "$BASE_PATH/dto/response" ]; then
            echo "‚úÖ dto/request/ and dto/response/" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è dto/request/ or dto/response/ - MISSING" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Structure Score:** $SCORE/$MAX_SCORE packages found" >> $GITHUB_STEP_SUMMARY
          echo "structure_score=$SCORE" >> $GITHUB_OUTPUT

  # ============================================================================
  # JOB 5: Entity & Repository Analysis (Variant-Aware)
  # ============================================================================
  entity-analysis:
    name: üóÑÔ∏è Entity & Repository Analysis
    runs-on: ubuntu-latest
    needs: [ build, detect-variant ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze entities
        id: entities
        run: |
          echo "### üóÑÔ∏è Entity & Repository Analysis" >> $GITHUB_STEP_SUMMARY
          echo "**Variant:** ${{ needs.detect-variant.outputs.variant_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          ENTITY_PATH="src/main/java/ua/edu/viti/military/entity"
          REPO_PATH="src/main/java/ua/edu/viti/military/repository"
          VARIANT="${{ needs.detect-variant.outputs.variant }}"
          
          # Count entities
          ENTITY_COUNT=$(find $ENTITY_PATH -name "*.java" -type f 2>/dev/null | grep -v "Test.java" | wc -l)
          echo "entities_count=$ENTITY_COUNT" >> $GITHUB_OUTPUT
          
          # Count repositories
          REPO_COUNT=$(find $REPO_PATH -name "*Repository.java" -type f 2>/dev/null | wc -l)
          echo "repositories_count=$REPO_COUNT" >> $GITHUB_OUTPUT
          
          echo "**Entity Classes:** $ENTITY_COUNT (Expected: 3+)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository Interfaces:** $REPO_COUNT (Expected: 3+)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for @Entity annotation
          ENTITY_ANNOTATED=$(grep -r "@Entity" $ENTITY_PATH 2>/dev/null | wc -l)
          echo "**@Entity annotations:** $ENTITY_ANNOTATED" >> $GITHUB_STEP_SUMMARY
          
          # Check for @Table annotation
          TABLE_ANNOTATED=$(grep -r "@Table" $ENTITY_PATH 2>/dev/null | wc -l)
          echo "**@Table annotations:** $TABLE_ANNOTATED" >> $GITHUB_STEP_SUMMARY
          
          # Check for relationships
          MANY_TO_ONE=$(grep -r "@ManyToOne" $ENTITY_PATH 2>/dev/null | wc -l)
          echo "**@ManyToOne relationships:** $MANY_TO_ONE" >> $GITHUB_STEP_SUMMARY
          
          # Check for auditing
          AUDITING=$(grep -r "@CreatedDate\|@LastModifiedDate" $ENTITY_PATH 2>/dev/null | wc -l)
          echo "**Auditing fields:** $AUDITING" >> $GITHUB_STEP_SUMMARY
          
          # Check for enums
          ENUM_COUNT=$(find $ENTITY_PATH -name "*.java" -type f -exec grep -l "^public enum" {} \; 2>/dev/null | wc -l)
          echo "**Enum classes:** $ENUM_COUNT (Expected: 2+)" >> $GITHUB_STEP_SUMMARY
          
          # Variant-specific enum checks
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Variant-Specific Enum Classes:**" >> $GITHUB_STEP_SUMMARY
          
          if [ "$VARIANT" = "A" ]; then
            if grep -r "enum HazardClass" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ HazardClass enum" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå HazardClass enum - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -r "enum ItemStatus" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ ItemStatus enum" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå ItemStatus enum - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$VARIANT" = "B" ]; then
            if grep -r "enum FuelType" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ FuelType enum" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå FuelType enum - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -r "enum VehicleStatus" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ VehicleStatus enum" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå VehicleStatus enum - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$VARIANT" = "C" ]; then
            if grep -r "enum Rank" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ Rank enum" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå Rank enum - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -r "enum SecurityClearance" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ SecurityClearance enum" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå SecurityClearance enum - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -r "enum MedicalCategory" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ MedicalCategory enum" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå MedicalCategory enum - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Variant-specific field checks
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Variant-Specific Required Fields:**" >> $GITHUB_STEP_SUMMARY
          
          if [ "$VARIANT" = "A" ]; then
            if grep -r "private.*batchNumber" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ batchNumber field" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå batchNumber field - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -r "private.*expirationDate" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ expirationDate field" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è expirationDate field - MISSING (optional but recommended)" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -r "private.*HazardClass.*hazardClass" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ hazardClass field" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå hazardClass field - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$VARIANT" = "B" ]; then
            if grep -r "private.*registrationNumber" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ registrationNumber field" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå registrationNumber field - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -r "private.*mileage" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ mileage field" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå mileage field - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -r "private.*FuelType.*fuelType" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ fuelType field" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå fuelType field - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$VARIANT" = "C" ]; then
            if grep -r "private.*militaryId" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ militaryId field" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå militaryId field - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -r "private.*Rank.*rank" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ rank field" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå rank field - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -r "private.*contractEndDate" $ENTITY_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ contractEndDate field" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå contractEndDate field - MISSING" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Check Repository methods
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository Query Methods:**" >> $GITHUB_STEP_SUMMARY
          FIND_BY=$(grep -r "findBy" $REPO_PATH 2>/dev/null | wc -l)
          EXISTS_BY=$(grep -r "existsBy" $REPO_PATH 2>/dev/null | wc -l)
          COUNT_BY=$(grep -r "countBy" $REPO_PATH 2>/dev/null | wc -l)
          JPQL_QUERIES=$(grep -r "@Query" $REPO_PATH 2>/dev/null | wc -l)
          
          echo "- findBy* methods: $FIND_BY" >> $GITHUB_STEP_SUMMARY
          echo "- existsBy* methods: $EXISTS_BY" >> $GITHUB_STEP_SUMMARY
          echo "- countBy* methods: $COUNT_BY" >> $GITHUB_STEP_SUMMARY
          echo "- @Query (JPQL): $JPQL_QUERIES" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 6: Service Layer Analysis
  # ============================================================================
  service-analysis:
    name: üíº Service Layer Analysis
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze services
        run: |
          echo "### üíº Service Layer Analysis" >> $GITHUB_STEP_SUMMARY
          
          SERVICE_PATH="src/main/java/ua/edu/viti/military/service"
          
          # Count services
          SERVICE_COUNT=$(find $SERVICE_PATH -name "*Service.java" -type f 2>/dev/null | grep -v "Test.java" | wc -l)
          echo "**Service Classes:** $SERVICE_COUNT (Expected: 3+)" >> $GITHUB_STEP_SUMMARY
          
          # Check for @Service annotation
          SERVICE_ANNOTATED=$(grep -r "@Service" $SERVICE_PATH 2>/dev/null | wc -l)
          echo "**@Service annotations:** $SERVICE_ANNOTATED" >> $GITHUB_STEP_SUMMARY
          
          # Check for @Transactional
          TRANSACTIONAL=$(grep -r "@Transactional" $SERVICE_PATH 2>/dev/null | wc -l)
          echo "**@Transactional usage:** $TRANSACTIONAL" >> $GITHUB_STEP_SUMMARY
          
          # Check for CRUD methods
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CRUD Methods Found:**" >> $GITHUB_STEP_SUMMARY
          CREATE=$(grep -r "public.*create\|public.*save" $SERVICE_PATH 2>/dev/null | wc -l)
          READ=$(grep -r "public.*getById\|public.*findById" $SERVICE_PATH 2>/dev/null | wc -l)
          UPDATE=$(grep -r "public.*update" $SERVICE_PATH 2>/dev/null | wc -l)
          DELETE=$(grep -r "public.*delete" $SERVICE_PATH 2>/dev/null | wc -l)
          GET_ALL=$(grep -r "public.*getAll\|public.*findAll" $SERVICE_PATH 2>/dev/null | wc -l)
          
          echo "- Create methods: $CREATE" >> $GITHUB_STEP_SUMMARY
          echo "- Read methods: $READ" >> $GITHUB_STEP_SUMMARY
          echo "- Update methods: $UPDATE" >> $GITHUB_STEP_SUMMARY
          echo "- Delete methods: $DELETE" >> $GITHUB_STEP_SUMMARY
          echo "- GetAll methods: $GET_ALL" >> $GITHUB_STEP_SUMMARY
          
          # Check for exception handling
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Exception Handling:**" >> $GITHUB_STEP_SUMMARY
          THROWS_EXCEPTIONS=$(grep -r "throw new" $SERVICE_PATH 2>/dev/null | wc -l)
          echo "- Exception throws: $THROWS_EXCEPTIONS" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 7: Controller & REST API Analysis (Variant-Aware)
  # ============================================================================
  controller-analysis:
    name: üåê Controller & REST API Analysis
    runs-on: ubuntu-latest
    needs: [ build, detect-variant ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze controllers
        run: |
          echo "### üåê Controller & REST API Analysis" >> $GITHUB_STEP_SUMMARY
          echo "**Variant:** ${{ needs.detect-variant.outputs.variant_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CONTROLLER_PATH="src/main/java/ua/edu/viti/military/controller"
          VARIANT="${{ needs.detect-variant.outputs.variant }}"
          
          # Count controllers
          CONTROLLER_COUNT=$(find $CONTROLLER_PATH -name "*Controller.java" -type f 2>/dev/null | wc -l)
          echo "**Controller Classes:** $CONTROLLER_COUNT (Expected: 3+)" >> $GITHUB_STEP_SUMMARY
          
          # Check REST annotations
          REST_CONTROLLER=$(grep -r "@RestController" $CONTROLLER_PATH 2>/dev/null | wc -l)
          REQUEST_MAPPING=$(grep -r "@RequestMapping" $CONTROLLER_PATH 2>/dev/null | wc -l)
          echo "**@RestController:** $REST_CONTROLLER" >> $GITHUB_STEP_SUMMARY
          echo "**@RequestMapping:** $REQUEST_MAPPING" >> $GITHUB_STEP_SUMMARY
          
          # Check HTTP methods
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**HTTP Method Mappings:**" >> $GITHUB_STEP_SUMMARY
          GET=$(grep -r "@GetMapping" $CONTROLLER_PATH 2>/dev/null | wc -l)
          POST=$(grep -r "@PostMapping" $CONTROLLER_PATH 2>/dev/null | wc -l)
          PUT=$(grep -r "@PutMapping" $CONTROLLER_PATH 2>/dev/null | wc -l)
          DELETE=$(grep -r "@DeleteMapping" $CONTROLLER_PATH 2>/dev/null | wc -l)
          
          echo "- @GetMapping: $GET" >> $GITHUB_STEP_SUMMARY
          echo "- @PostMapping: $POST" >> $GITHUB_STEP_SUMMARY
          echo "- @PutMapping: $PUT" >> $GITHUB_STEP_SUMMARY
          echo "- @DeleteMapping: $DELETE" >> $GITHUB_STEP_SUMMARY
          
          # Check validation
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Validation:**" >> $GITHUB_STEP_SUMMARY
          VALID=$(grep -r "@Valid" $CONTROLLER_PATH 2>/dev/null | wc -l)
          VALIDATED=$(grep -r "@Validated" $CONTROLLER_PATH 2>/dev/null | wc -l)
          echo "- @Valid usage: $VALID" >> $GITHUB_STEP_SUMMARY
          echo "- @Validated usage: $VALIDATED" >> $GITHUB_STEP_SUMMARY
          
          # Check ResponseEntity
          RESPONSE_ENTITY=$(grep -r "ResponseEntity" $CONTROLLER_PATH 2>/dev/null | wc -l)
          echo "- ResponseEntity usage: $RESPONSE_ENTITY" >> $GITHUB_STEP_SUMMARY
          
          # Check Swagger annotations
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Swagger/OpenAPI Documentation:**" >> $GITHUB_STEP_SUMMARY
          TAG=$(grep -r "@Tag" $CONTROLLER_PATH 2>/dev/null | wc -l)
          OPERATION=$(grep -r "@Operation" $CONTROLLER_PATH 2>/dev/null | wc -l)
          echo "- @Tag: $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- @Operation: $OPERATION" >> $GITHUB_STEP_SUMMARY
          
          # Check variant-specific endpoints
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Variant-Specific Endpoints:**" >> $GITHUB_STEP_SUMMARY
          
          if [ "$VARIANT" = "A" ]; then
            if grep -r "expiring-soon\|expiringSoon" $CONTROLLER_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ /expiring-soon endpoint (materials with expiration date)" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è /expiring-soon endpoint - MISSING (recommended)" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$VARIANT" = "B" ]; then
            if grep -r "requiring-maintenance\|requiringMaintenance" $CONTROLLER_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ /requiring-maintenance endpoint (vehicles needing TO)" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è /requiring-maintenance endpoint - MISSING (recommended)" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$VARIANT" = "C" ]; then
            if grep -r "contracts-expiring\|contractsExpiring" $CONTROLLER_PATH 2>/dev/null > /dev/null; then
              echo "‚úÖ /contracts-expiring endpoint (personnel contracts)" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è /contracts-expiring endpoint - MISSING (recommended)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # ============================================================================
  # JOB 8: DTO & Validation Analysis
  # ============================================================================
  dto-validation-analysis:
    name: üì¶ DTO & Validation Analysis
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze DTOs and validation
        run: |
          echo "### üì¶ DTO & Validation Analysis" >> $GITHUB_STEP_SUMMARY
          
          DTO_PATH="src/main/java/ua/edu/viti/military/dto"
          
          # Count DTOs
          REQUEST_DTO=$(find $DTO_PATH/request -name "*.java" -type f 2>/dev/null | wc -l)
          RESPONSE_DTO=$(find $DTO_PATH/response -name "*.java" -type f 2>/dev/null | wc -l)
          
          echo "**DTO Classes:**" >> $GITHUB_STEP_SUMMARY
          echo "- Request DTOs: $REQUEST_DTO (Expected: 6+)" >> $GITHUB_STEP_SUMMARY
          echo "- Response DTOs: $RESPONSE_DTO (Expected: 3+)" >> $GITHUB_STEP_SUMMARY
          
          # Check validation annotations
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Validation Annotations:**" >> $GITHUB_STEP_SUMMARY
          NOT_NULL=$(grep -r "@NotNull" $DTO_PATH 2>/dev/null | wc -l)
          NOT_BLANK=$(grep -r "@NotBlank" $DTO_PATH 2>/dev/null | wc -l)
          SIZE=$(grep -r "@Size" $DTO_PATH 2>/dev/null | wc -l)
          POSITIVE=$(grep -r "@Positive" $DTO_PATH 2>/dev/null | wc -l)
          FUTURE=$(grep -r "@Future" $DTO_PATH 2>/dev/null | wc -l)
          EMAIL=$(grep -r "@Email" $DTO_PATH 2>/dev/null | wc -l)
          PATTERN=$(grep -r "@Pattern" $DTO_PATH 2>/dev/null | wc -l)
          
          echo "- @NotNull: $NOT_NULL" >> $GITHUB_STEP_SUMMARY
          echo "- @NotBlank: $NOT_BLANK" >> $GITHUB_STEP_SUMMARY
          echo "- @Size: $SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- @Positive: $POSITIVE" >> $GITHUB_STEP_SUMMARY
          echo "- @Future: $FUTURE" >> $GITHUB_STEP_SUMMARY
          echo "- @Email: $EMAIL" >> $GITHUB_STEP_SUMMARY
          echo "- @Pattern: $PATTERN" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 9: Exception Handling Analysis
  # ============================================================================
  exception-analysis:
    name: ‚ö†Ô∏è Exception Handling Analysis
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze exception handling
        run: |
          echo "### ‚ö†Ô∏è Exception Handling Analysis" >> $GITHUB_STEP_SUMMARY
          
          EXCEPTION_PATH="src/main/java/ua/edu/viti/military/exception"
          
          # Count custom exceptions
          CUSTOM_EXCEPTIONS=$(find $EXCEPTION_PATH -name "*Exception.java" -type f 2>/dev/null | wc -l)
          echo "**Custom Exception Classes:** $CUSTOM_EXCEPTIONS (Expected: 3+)" >> $GITHUB_STEP_SUMMARY
          
          # Check for specific exceptions
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Required Exceptions:**" >> $GITHUB_STEP_SUMMARY
          
          if grep -r "ResourceNotFoundException" $EXCEPTION_PATH 2>/dev/null > /dev/null; then
            echo "‚úÖ ResourceNotFoundException" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå ResourceNotFoundException - MISSING" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -r "DuplicateResourceException" $EXCEPTION_PATH 2>/dev/null > /dev/null; then
            echo "‚úÖ DuplicateResourceException" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå DuplicateResourceException - MISSING" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -r "BusinessLogicException" $EXCEPTION_PATH 2>/dev/null > /dev/null; then
            echo "‚úÖ BusinessLogicException" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå BusinessLogicException - MISSING" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for GlobalExceptionHandler
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -r "@RestControllerAdvice\|@ControllerAdvice" $EXCEPTION_PATH 2>/dev/null > /dev/null; then
            echo "‚úÖ **GlobalExceptionHandler** with @RestControllerAdvice" >> $GITHUB_STEP_SUMMARY
          
            EXCEPTION_HANDLERS=$(grep -r "@ExceptionHandler" $EXCEPTION_PATH 2>/dev/null | wc -l)
            echo "- @ExceptionHandler methods: $EXCEPTION_HANDLERS" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **GlobalExceptionHandler** - MISSING" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for ErrorResponse
          if find $EXCEPTION_PATH -name "ErrorResponse.java" -type f 2>/dev/null | grep -q .; then
            echo "‚úÖ ErrorResponse class (RFC 7807)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è ErrorResponse class - MISSING" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # JOB 10: Integration Tests with Postman/Newman (Variant-Aware)
  # ============================================================================
  postman-tests:
    name: üß™ API Integration Tests
    runs-on: ubuntu-latest
    needs: [ build, detect-variant ]
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: military_db
          POSTGRES_USER: military_user
          POSTGRES_PASSWORD: military_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/

      - name: Update application.yaml for tests
        run: |
          cat > src/main/resources/application.yaml <<EOF
          spring:
            application:
              name: military-api
            datasource:
              url: jdbc:postgresql://localhost:5432/military_db
              username: military_user
              password: military_pass
              driver-class-name: org.postgresql.Driver
            jpa:
              hibernate:
                ddl-auto: update
              show-sql: false
          server:
            port: 8080
          springdoc:
            api-docs:
              path: /v3/api-docs
            swagger-ui:
              path: /swagger-ui.html
          EOF

      - name: Start Spring Boot Application
        run: |
          java -jar target/*.jar &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # Wait for application to start
          echo "Waiting for application to start..."
          for i in {1..60}; do
            if curl -s http://localhost:8080/v3/api-docs > /dev/null 2>&1; then
              echo "Application started successfully!"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Application failed to start"
              kill $APP_PID || true
              exit 1
            fi
            sleep 2
          done

      - name: Install Newman (Postman CLI)
        run: npm install -g newman newman-reporter-htmlextra

      - name: Create Postman collection for variant
        run: |
          VARIANT="${{ needs.detect-variant.outputs.variant }}"
          python3 .github/scripts/generate_postman.py $VARIANT

      - name: Run Postman tests with Newman
        id: newman
        continue-on-error: true
        run: |
          newman run postman-collection.json \
          --reporters cli,htmlextra \
          --reporter-htmlextra-export newman-report.html \
          --reporter-htmlextra-darkTheme \
          --color on \
          > newman-output.txt 2>&1
          
          NEWMAN_EXIT_CODE=$?
          echo "exit_code=$NEWMAN_EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Extract test results
          TOTAL=$(grep -oP 'executed.*?\K\d+(?=\/)' newman-output.txt | head -1 || echo "0")
          FAILED=$(grep -oP 'failed.*?\K\d+' newman-output.txt | head -1 || echo "0")
          PASSED=$((TOTAL - FAILED))
          
          echo "total_tests=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED" >> $GITHUB_OUTPUT
          
          echo "### üß™ API Integration Tests Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Variant:** ${{ needs.detect-variant.outputs.variant_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total Tests: $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- Passed: ‚úÖ $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: ‚ùå $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$NEWMAN_EXIT_CODE" -eq 0 ]; then
          echo "‚úÖ **All API tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
          echo "‚ùå **Some API tests failed. Review the detailed report.**" >> $GITHUB_STEP_SUMMARY
          fi
        
          - name: Upload Newman report
            if: always()
            uses: actions/upload-artifact@v4
            with:
              name: newman-report
              path: |
                newman-report.html
                newman-output.txt
                postman-collection.json
        
          - name: Stop application
            if: always()
            run: |
              kill ${{ env.APP_PID }} || true

        # ============================================================================
        # JOB 11: Swagger/OpenAPI Documentation Check
        # ============================================================================
  swagger-check:
    name: üìö Swagger Documentation Check
    runs-on: ubuntu-latest
    needs: build

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: military_db
          POSTGRES_USER: military_user
          POSTGRES_PASSWORD: military_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/

      - name: Update application.yaml for tests
        run: |
          cat > src/main/resources/application.yaml <<EOF
          spring:
            application:
              name: military-api
            datasource:
              url: jdbc:postgresql://localhost:5432/military_db
              username: military_user
              password: military_pass
              driver-class-name: org.postgresql.Driver
            jpa:
              hibernate:
                ddl-auto: update
              show-sql: false
          server:
            port: 8080
          springdoc:
            api-docs:
              path: /v3/api-docs
            swagger-ui:
              path: /swagger-ui.html
          EOF

      - name: Start application
        run: |
          java -jar target/*.jar &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          for i in {1..60}; do
            if curl -s http://localhost:8080/v3/api-docs > /dev/null 2>&1; then
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Failed to start application"
              kill $APP_PID || true
              exit 1
            fi
            sleep 2
          done

      - name: Check Swagger UI availability
        id: swagger
        run: |
          echo "### üìö Swagger Documentation Check" >> $GITHUB_STEP_SUMMARY
          
          # Check Swagger UI
          if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/swagger-ui.html | grep -q "200"; then
            echo "‚úÖ **Swagger UI:** Available at /swagger-ui.html" >> $GITHUB_STEP_SUMMARY
            echo "swagger_ui=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå **Swagger UI:** NOT available" >> $GITHUB_STEP_SUMMARY
            echo "swagger_ui=false" >> $GITHUB_OUTPUT
          fi
          
          # Check OpenAPI docs
          if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/v3/api-docs | grep -q "200"; then
            echo "‚úÖ **OpenAPI Docs:** Available at /v3/api-docs" >> $GITHUB_STEP_SUMMARY
            echo "openapi_docs=true" >> $GITHUB_OUTPUT
          
            # Download and analyze OpenAPI spec
            curl -s http://localhost:8080/v3/api-docs > openapi.json
          
            ENDPOINTS=$(jq '[.paths | to_entries[] | .value | to_entries[]] | length' openapi.json)
            echo "- Total documented endpoints: $ENDPOINTS" >> $GITHUB_STEP_SUMMARY
          
            TAGS=$(jq '[.tags[]?.name] | length' openapi.json)
            echo "- API tags: $TAGS" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **OpenAPI Docs:** NOT available" >> $GITHUB_STEP_SUMMARY
            echo "openapi_docs=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop application
        if: always()
        run: kill ${{ env.APP_PID }} || true

      - name: Upload OpenAPI spec
        if: steps.swagger.outputs.openapi_docs == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.json

  # ============================================================================
  # JOB 12: Calculate Final Score
  # ============================================================================
  calculate-score:
    name: üéØ Calculate Final Score
    runs-on: ubuntu-latest
    needs:
      - detect-variant
      - build
      - checkstyle
      - structure-check
      - entity-analysis
      - service-analysis
      - controller-analysis
      - dto-validation-analysis
      - exception-analysis
      - postman-tests
      - swagger-check
    if: always()

    steps:
      - name: Calculate final score
        run: |
          echo "# üìä –ü–ó 1/2 - –ü—ñ–¥—Å—É–º–∫–æ–≤–∞ –û—Ü—ñ–Ω–∫–∞" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–í–∞—Ä—ñ–∞–Ω—Ç:** ${{ needs.detect-variant.outputs.variant_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_SCORE=0
          MAX_SCORE=30
          
          echo "## –î–µ—Ç–∞–ª—å–Ω–∞ –†–æ–∑–±–∏–≤–∫–∞" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Build (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ - —è–∫—â–æ –Ω–µ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è = 0)
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "‚úÖ **Build & Compile:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Build & Compile:** FAILED - 0 –±–∞–ª—ñ–≤ (–Ω–µ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## üî¥ –§—ñ–Ω–∞–ª—å–Ω–∏–π –±–∞–ª: 0 / $MAX_SCORE" >> $GITHUB_STEP_SUMMARY
            echo "**–ü—Ä–æ—î–∫—Ç –Ω–µ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è. –í–∏–ø—Ä–∞–≤—Ç–µ –ø–æ–º–∏–ª–∫–∏ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó.**" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Entity + Repository (6 –±–∞–ª—ñ–≤)
          echo "### 1. Entity + Repository (–º–∞–∫—Å. 6 –±–∞–ª—ñ–≤)" >> $GITHUB_STEP_SUMMARY
          ENTITY_SCORE=6
          TOTAL_SCORE=$((TOTAL_SCORE + ENTITY_SCORE))
          echo "- –û—Ü—ñ–Ω–∫–∞: $ENTITY_SCORE/6 (–¥–µ—Ç–∞–ª—ñ –≤ Entity Analysis)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Service Layer (6 –±–∞–ª—ñ–≤)
          echo "### 2. Service Layer (–º–∞–∫—Å. 6 –±–∞–ª—ñ–≤)" >> $GITHUB_STEP_SUMMARY
          SERVICE_SCORE=6
          TOTAL_SCORE=$((TOTAL_SCORE + SERVICE_SCORE))
          echo "- –û—Ü—ñ–Ω–∫–∞: $SERVICE_SCORE/6 (–¥–µ—Ç–∞–ª—ñ –≤ Service Analysis)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # REST Controllers (8 –±–∞–ª—ñ–≤)
          echo "### 3. REST Controllers (–º–∞–∫—Å. 8 –±–∞–ª—ñ–≤)" >> $GITHUB_STEP_SUMMARY
          CONTROLLER_SCORE=8
          TOTAL_SCORE=$((TOTAL_SCORE + CONTROLLER_SCORE))
          echo "- –û—Ü—ñ–Ω–∫–∞: $CONTROLLER_SCORE/8 (–¥–µ—Ç–∞–ª—ñ in Controller Analysis)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Validation (4 –±–∞–ª–∏)
          echo "### 4. Validation (–º–∞–∫—Å. 4 –±–∞–ª–∏)" >> $GITHUB_STEP_SUMMARY
          VALIDATION_SCORE=4
          TOTAL_SCORE=$((TOTAL_SCORE + VALIDATION_SCORE))
          echo "- –û—Ü—ñ–Ω–∫–∞: $VALIDATION_SCORE/4 (–¥–µ—Ç–∞–ª—ñ in DTO Analysis)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Exception Handling (4 –±–∞–ª–∏)
          echo "### 5. Exception Handling (–º–∞–∫—Å. 4 –±–∞–ª–∏)" >> $GITHUB_STEP_SUMMARY
          EXCEPTION_SCORE=4
          TOTAL_SCORE=$((TOTAL_SCORE + EXCEPTION_SCORE))
          echo "- –û—Ü—ñ–Ω–∫–∞: $EXCEPTION_SCORE/4 (–¥–µ—Ç–∞–ª—ñ in Exception Analysis)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Swagger (2 –±–∞–ª–∏)
          echo "### 6. Swagger Documentation (–º–∞–∫—Å. 2 –±–∞–ª–∏)" >> $GITHUB_STEP_SUMMARY
          SWAGGER_SCORE=2
          TOTAL_SCORE=$((TOTAL_SCORE + SWAGGER_SCORE))
          echo "- –û—Ü—ñ–Ω–∫–∞: $SWAGGER_SCORE/2 (–¥–µ—Ç–∞–ª—ñ in Swagger Check)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # API Integration Tests
          echo "### 7. API Integration Tests (—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–æ)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.postman-tests.outputs.passed_tests }}" != "" ]; then
            echo "- Passed: ${{ needs.postman-tests.outputs.passed_tests }} / ${{ needs.postman-tests.outputs.total_tests }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Final Score
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ü–æ–ø–µ—Ä–µ–¥–Ω—è –û—Ü—ñ–Ω–∫–∞: $TOTAL_SCORE / $MAX_SCORE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**‚ö†Ô∏è –¶–µ –ü–û–ü–ï–†–ï–î–ù–Ø –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –æ—Ü—ñ–Ω–∫–∞.**" >> $GITHUB_STEP_SUMMARY
          echo "–§—ñ–Ω–∞–ª—å–Ω—É –æ—Ü—ñ–Ω–∫—É –≤–∏—Å—Ç–∞–≤–ª—è—î –≤–∏–∫–ª–∞–¥–∞—á –ø—ñ—Å–ª—è:" >> $GITHUB_STEP_SUMMARY
          echo "- –ü–µ—Ä–µ–≥–ª—è–¥—É —è–∫–æ—Å—Ç—ñ –∫–æ–¥—É" >> $GITHUB_STEP_SUMMARY
          echo "- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏" >> $GITHUB_STEP_SUMMARY
          echo "- –£—Å–Ω–æ—ó –∑–¥–∞—á—ñ —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          PERCENTAGE=$((TOTAL_SCORE * 100 / MAX_SCORE))
          if [ $PERCENTAGE -ge 90 ]; then
            echo "üìà **–†—ñ–≤–µ–Ω—å:** –í—ñ–¥–º—ñ–Ω–Ω–æ (90%+)" >> $GITHUB_STEP_SUMMARY
          elif [ $PERCENTAGE -ge 75 ]; then
            echo "üìä **–†—ñ–≤–µ–Ω—å:** –î–æ–±—Ä–µ (75-89%)" >> $GITHUB_STEP_SUMMARY
          elif [ $PERCENTAGE -ge 60 ]; then
            echo "üìâ **–†—ñ–≤–µ–Ω—å:** –ó–∞–¥–æ–≤—ñ–ª—å–Ω–æ (60-74%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **–†—ñ–≤–µ–Ω—å:** –ü–æ—Ç—Ä–µ–±—É—î –¥–æ–æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è (<60%)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:**" >> $GITHUB_STEP_SUMMARY
          echo "1. –ü–µ—Ä–µ–≥–ª—è–Ω–µ—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ñ –∑–≤—ñ—Ç–∏ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö jobs" >> $GITHUB_STEP_SUMMARY
          echo "2. –í–∏–ø—Ä–∞–≤—Ç–µ –≤–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏" >> $GITHUB_STEP_SUMMARY
          echo "3. –ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ—Å—è –¥–æ —É—Å–Ω–æ—ó –∑–¥–∞—á—ñ" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 13: Comment on PR with results
  # ============================================================================
  comment-results:
    name: üí¨ Post Results to PR
    runs-on: ubuntu-latest
    needs: [ detect-variant, calculate-score ]
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ü–ó 1/2
            
              **–í–∞—Ä—ñ–∞–Ω—Ç:** ${{ needs.detect-variant.outputs.variant_name }}
            
              –í–∞—à Pull Request –±—É–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∏–π.
            
              üìä **–î–µ—Ç–∞–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤:**
              - GitHub Actions Summary (–ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤–≥–æ—Ä—ñ)
              - Artifacts (Newman reports, Checkstyle, OpenAPI spec)
            
              ‚ö†Ô∏è **–í–∞–∂–ª–∏–≤–æ:** –¶–µ –ø–æ–ø–µ—Ä–µ–¥–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –æ—Ü—ñ–Ω–∫–∞.
              –§—ñ–Ω–∞–ª—å–Ω—É –æ—Ü—ñ–Ω–∫—É –≤–∏—Å—Ç–∞–≤–ª—è—î –≤–∏–∫–ª–∞–¥–∞—á –ø—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–æ–¥—É —Ç–∞ —É—Å–Ω–æ—ó –∑–¥–∞—á—ñ.
            
              **–ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:**
              1. –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ñ –∑–≤—ñ—Ç–∏
              2. –í–∏–ø—Ä–∞–≤—Ç–µ –≤–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏
              3. –û–Ω–æ–≤—ñ—Ç—å Pull Request (push –≤ –≥—ñ–ª–∫—É stage-1)
              4. –ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ—Å—è –¥–æ —É—Å–Ω–æ—ó –∑–¥–∞—á—ñ
            
              –£—Å–ø—ñ—Ö—ñ–≤! üöÄ`
            });
